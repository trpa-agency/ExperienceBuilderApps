System.register(["jimu-core","jimu-ui","jimu-ui/basic/list-tree","jimu-theme","jimu-arcgis","jimu-ui/basic/sql-expression-runtime","jimu-ui/advanced/map","jimu-layouts/layout-runtime"],(function(e,t){var a={},n={},s={},o={},r={},l={},i={},c={};return{setters:[function(e){a.BaseVersionManager=e.BaseVersionManager,a.CONSTANTS=e.CONSTANTS,a.DataRecordSetChangeMessage=e.DataRecordSetChangeMessage,a.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,a.DataSourceComponent=e.DataSourceComponent,a.DataSourceManager=e.DataSourceManager,a.DataSourceStatus=e.DataSourceStatus,a.Immutable=e.Immutable,a.MessageManager=e.MessageManager,a.React=e.React,a.ReactRedux=e.ReactRedux,a.RecordSetChangeType=e.RecordSetChangeType,a.appConfigUtils=e.appConfigUtils,a.classNames=e.classNames,a.css=e.css,a.dataSourceUtils=e.dataSourceUtils,a.getAppStore=e.getAppStore,a.hooks=e.hooks,a.injectIntl=e.injectIntl,a.isKeyboardMode=e.isKeyboardMode,a.jsx=e.jsx,a.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,a.lodash=e.lodash,a.moduleLoader=e.moduleLoader,a.utils=e.utils},function(e){n.Button=e.Button,n.Checkbox=e.Checkbox,n.DataActionList=e.DataActionList,n.DataActionListStyle=e.DataActionListStyle,n.FOCUSABLE_CONTAINER_CLASS=e.FOCUSABLE_CONTAINER_CLASS,n.Icon=e.Icon,n.Loading=e.Loading,n.LoadingType=e.LoadingType,n.MobilePanel=e.MobilePanel,n.Modal=e.Modal,n.ModalBody=e.ModalBody,n.ModalFooter=e.ModalFooter,n.NumericInput=e.NumericInput,n.Pagination=e.Pagination,n.PanelHeader=e.PanelHeader,n.Popper=e.Popper,n.Select=e.Select,n.Tooltip=e.Tooltip,n.WidgetPlaceholder=e.WidgetPlaceholder,n.defaultMessages=e.defaultMessages},function(e){s.List=e.List,s.TreeItemActionType=e.TreeItemActionType},function(e){o.withTheme=e.withTheme},function(e){r.JimuMapViewComponent=e.JimuMapViewComponent,r.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){l.SqlExpressionRuntime=e.SqlExpressionRuntime,l.getShownClauseNumberByExpression=e.getShownClauseNumberByExpression},function(e){i.JimuDrawCreationMode=e.JimuDrawCreationMode},function(e){c.LayoutItemSizeModes=e.LayoutItemSizeModes}],execute:function(){e((()=>{var e={6992:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#fff" d="M14.417 0H0v12.888h5.607v-.805H.8V.806h12.815V6.04h.801V0Z"></path><path fill="#fff" fill-rule="evenodd" d="M10.412 14.902a4.373 4.373 0 0 0 2.868-1.067L15.434 16l.566-.57-2.161-2.173c.612-.761.979-1.73.979-2.785 0-2.447-1.973-4.43-4.405-4.43-2.433 0-4.406 1.983-4.406 4.43 0 2.447 1.973 4.43 4.405 4.43Zm0-.805c1.991 0 3.605-1.623 3.605-3.625s-1.614-3.625-3.604-3.625c-1.991 0-3.605 1.623-3.605 3.625s1.614 3.625 3.604 3.625Z" clip-rule="evenodd"></path><path fill="#fff" d="M2.403 2.417h9.611v.805H2.403v-.805ZM7.209 4.833H2.403v.806h4.806v-.806ZM2.403 7.25h2.403v.805H2.403V7.25ZM4.806 9.666H2.403v.806h2.403v-.806Z"></path></svg>'},10119:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="m14 4-6 8-6-8h12Z"></path></svg>'},98940:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="m4 2 8 6-8 6V2Z"></path></svg>'},95369:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M2 7a1 1 0 1 0 0 2 1 1 0 0 0 0-2Zm5 1a1 1 0 1 1 2 0 1 1 0 0 1-2 0Zm6 0a1 1 0 1 1 2 0 1 1 0 0 1-2 0Z" clip-rule="evenodd"></path></svg>'},33869:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M15 7.5a.522.522 0 0 1-.516.527H2.976L6.473 11.6a.535.535 0 0 1 0 .746.508.508 0 0 1-.73 0L1 7.5l4.743-4.846a.508.508 0 0 1 .73 0 .535.535 0 0 1 0 .746L2.976 6.973h11.508c.285 0 .516.236.516.527Z"></path></svg>'},3273:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M4.653 13.854a.485.485 0 0 1 0-.708L10.24 8 4.653 2.854a.485.485 0 0 1 0-.708.538.538 0 0 1 .738 0l5.956 5.5a.485.485 0 0 1 0 .708l-5.956 5.5a.538.538 0 0 1-.738 0Z" clip-rule="evenodd"></path></svg>'},65283:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M.438 1C.196 1 0 1.224 0 1.5s.196.5.438.5h15.124c.242 0 .438-.224.438-.5s-.196-.5-.438-.5H.438ZM0 7.5c0-.276.196-.5.438-.5h15.124c.242 0 .438.224.438.5s-.196.5-.438.5H.438C.196 8 0 7.776 0 7.5ZM0 13.5c0-.276.196-.5.438-.5h15.124c.242 0 .438.224.438.5s-.196.5-.438.5H.438C.196 14 0 13.776 0 13.5Z"></path></svg>'},54357:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M6 6.5a.5.5 0 0 1 1 0v6a.5.5 0 0 1-1 0v-6ZM9.5 6a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 1 0v-6a.5.5 0 0 0-.5-.5Z"></path><path fill="#000" fill-rule="evenodd" d="M11 0H5a1 1 0 0 0-1 1v2H.5a.5.5 0 0 0 0 1h1.6l.81 11.1a1 1 0 0 0 .995.9h8.19a1 1 0 0 0 .995-.9L13.9 4h1.6a.5.5 0 0 0 0-1H12V1a1 1 0 0 0-1-1Zm0 3V1H5v2h6Zm1.895 1h-9.79l.8 11h8.19l.8-11Z" clip-rule="evenodd"></path></svg>'},88866:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM6.5 7.5A.5.5 0 0 1 7 7h1.5v4.5h1a.5.5 0 0 1 0 1h-3a.5.5 0 0 1 0-1h1V8H7a.5.5 0 0 1-.5-.5Z"></path><path fill="#000" fill-rule="evenodd" d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm0-1A7 7 0 1 0 8 1a7 7 0 0 0 0 14Z" clip-rule="evenodd"></path></svg>'},79964:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8 2.125 14.334 14H1.667L8 2.125Zm-.882-.47a1 1 0 0 1 1.765 0l6.333 11.874A1 1 0 0 1 14.334 15H1.667a1 1 0 0 1-.882-1.47L7.118 1.653ZM8 4.874a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0L8.9 5.87a.905.905 0 0 0-.9-.995Zm1 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z" clip-rule="evenodd"></path></svg>'},94539:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M4 4.796 4.796 4 8.02 7.224l3.184-3.184.796.796L8.816 8.02l3.144 3.144-.796.796L8.02 8.816 4.836 12l-.796-.796L7.224 8.02 4 4.796Z"></path><path fill="#000" fill-rule="evenodd" d="m0 4 4-4h8l4 4v8l-4 4H4l-4-4V4Zm1 .414L4.414 1h7.172L15 4.414v7.172L11.586 15H4.414L1 11.586V4.414Z" clip-rule="evenodd"></path></svg>'},26826:e=>{"use strict";e.exports=r},48891:e=>{"use strict";e.exports=a},74758:e=>{"use strict";e.exports=c},34796:e=>{"use strict";e.exports=o},30726:e=>{"use strict";e.exports=n},58290:e=>{"use strict";e.exports=i},59587:e=>{"use strict";e.exports=s},15506:e=>{"use strict";e.exports=l}},t={};function u(a){var n=t[a];if(void 0!==n)return n.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,u),s.exports}u.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return u.d(t,{a:t}),t},u.d=(e,t)=>{for(var a in t)u.o(t,a)&&!u.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},u.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),u.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},u.p="";var d={};return u.p=window.jimuConfig.baseUrl,(()=>{"use strict";u.r(d),u.d(d,{__set_webpack_public_path__:()=>lt,default:()=>rt});var e,t,a,n,s,o=u(48891),r=u(30726);!function(e){e.Point="Point",e.Polyline="Polyline",e.Polygon="Polygon",e.Rectangle="Rectangle",e.Circle="Circle"}(e||(e={})),function(e){e.NewSelection="NEW_SELECTION",e.AddToSelection="ADD_TO_CURRENT_SELECTION",e.RemoveFromSelection="REMOVE_FROM_CURRENT_SELECTION",e.SubsetSelection="SUBSET_FROM_CURRENT_SELECTION",e.SwitchSelction="SWITCH_CURRENT_SELECTION"}(t||(t={})),function(e){e.Block="BLOCK",e.Inline="INLINE",e.Popper="POPPER"}(a||(a={})),function(e){e.CurrentMapExtent="CurrentMapExtent",e.InteractiveDrawMode="InteractiveDrawMode",e.None=""}(n||(n={})),function(e){e.Intersect="intersects",e.Contain="contains",e.Cross="crosses",e.EnvelopeIntersect="envelope-intersects",e.IndexIntersect="index-intersects",e.Overlap="overlaps",e.Touch="touches",e.Within="within"}(s||(s={}));const l={[s.Intersect]:"esriSpatialRelIntersects",[s.Contain]:"esriSpatialRelContains",[s.Cross]:"esriSpatialRelCrosses",[s.EnvelopeIntersect]:"esriSpatialRelEnvelopeIntersects",[s.IndexIntersect]:"esriSpatialRelIndexIntersects",[s.Overlap]:"esriSpatialRelOverlaps",[s.Touch]:"esriSpatialRelTouches",[s.Within]:"esriSpatialRelWithin"};var i;!function(e){e.Miles="Miles",e.Kilometers="Kilometers",e.Feet="Feet",e.Meters="Meters",e.NauticalMiles="NauticalMiles"}(i||(i={}));const c={[i.Miles]:"esriSRUnit_StatuteMile",[i.Kilometers]:"esriSRUnit_Kilometer",[i.Feet]:"esriSRUnit_Foot",[i.Meters]:"esriSRUnit_Meter",[i.NauticalMiles]:"esriSRUnit_NauticalMile"};var p,f,m,g,v;!function(e){e.Horizontal="Horizontal",e.Vertical="Vertical"}(p||(p={})),function(e){e.MultiPage="MultiPage",e.LazyLoad="LazyLoad"}(f||(f={})),function(e){e.PopupSetting="PopupSetting",e.SelectAttributes="SelectAttributes"}(m||(m={})),function(e){e.Asc="Asc",e.Desc="Desc"}(g||(g={})),function(e){e.DefaultSymbol="DefaultSymbol",e.CustomSymbol="CustomSymbol"}(v||(v={}));const h={_widgetLabel:"Query",noDataAvailable:"Error in loading data",noQueryItem:"No query",newQueryHint:'Add content by clicking the "{label}" button on the configuration panel',attributeFilter:"Attribute filter",spatialFilter:"Spatial filter",spatialFilterType_CurrentMapExtent:"Current map extent",spatialFilterType_InteractiveDrawMode:"Drawn graphic",relationship:"Relationship",spatialRelation_Intersect:"Intersect",spatialRelation_Contain:"Contain",spatialRelation_Cross:"Cross",spatialRelation_EnvelopeIntersect:"Envelope Intersect",spatialRelation_IndexIntersect:"Index Intersect",spatialRelation_Overlap:"Overlap",spatialRelation_Touch:"Touch",spatialRelation_Within:"Within",results:"Results",featuresDisplayed:"Features displayed",clearResult:"Clear results",checkResult:"Check results",mapMustBeVisible:"Map must be visible",chooseFilterType:"Choose the filter type",chooseGeometryType:"Choose the geometry type",clearDrawing:"Clear the graphic when applying",featureFromDs:"Selecting features from data source",featureFromMap:"Geometries from a map",chooseFilterLayer:"Choose a filter layer",selectedRecords:"{num} records are selected for the filter",bufferDistance:"Buffer distance",unit_Miles:"Miles",unit_Kilometers:"Kilometers",unit_Feet:"Feet",unit_Meters:"Meters",unit_Yards:"Yards",unit_NauticalMiles:"Nautical miles",spatialNotAvailable:"Spatial filter is not available here.",spatialNotAvailableDesc:"Spatial filter is not supported for a data source that already contains a spatial query."};var y=u(79964),S=u.n(y),x=u(94539),b=u.n(x),R=u(33869),w=u.n(R),I=u(3273),C=u.n(I),j=u(54357),N=u.n(j),M=u(95369),D=u.n(M);const O=()=>({iconMap:{iconQuery:u(6992),iconWarning:S(),iconError:b(),arrowNavBack:w(),arrowRight:C(),toolDelete:N(),iconMore:D()}});class P extends o.BaseVersionManager{constructor(){super(...arguments),this.versions=[{version:"1.5.0",description:"1.5.0",upgrader:e=>{var t;let a=e;return null===(t=e.queryItems)||void 0===t||t.forEach(((e,t)=>{null==e.useAttributeFilter&&(a=a.setIn(["queryItems",t,"useAttributeFilter"],!0)),null==e.useSpatialFilter&&(a=a.setIn(["queryItems",t,"useSpatialFilter"],!0))})),a}},{version:"1.6.0",description:"1.6.0",upgrader:e=>{var t;let a=e;if((null===(t=e.queryItems)||void 0===t?void 0:t.length)>0){const t=e.queryItems[0];a=a.set("resultListDirection",t.resultListDirection),a=a.set("resultPagingStyle",t.resultPagingStyle)}return a}}]}}const E=new P;var k=u(59587),T=u(34796);const{useState:L}=o.React;var B;(0,T.withTheme)((e=>{const{theme:t,panelVisible:a,setPanelVisible:n,getI18nMessage:s,isModal:l=!0,title:i=s("queryMessage"),bodyContent:c="",hasHeader:u=!0,hasFooter:d=!0}=e,p=()=>{n(!1)},f=()=>(0,o.jsx)(o.React.Fragment,null,u&&(0,o.jsx)(r.PanelHeader,{className:"py-2",title:i,onClose:p}),(0,o.jsx)(r.ModalBody,null,c),d&&(0,o.jsx)(r.ModalFooter,null,(0,o.jsx)(r.Button,{onClick:p},s("ok")))),m="ui-unit-dialog-panel";return l?(0,o.jsx)(r.Modal,{className:`${m}`,isOpen:a,toggle:p,backdrop:"static"},f()):(0,o.jsx)("div",{className:`${m} modal-dialog ${a?"":"collapse"}`,css:o.css`
      &.ui-unit-dialog-panel.modal-dialog {
        margin: 0;
        width: 100%;
        .modal-content {
          background-color: ${t.colors.palette.light[600]};
          color: ${t.colors.black};
          font-size: .75rem;
          font-weight: 400;
          border: none;
          .panel-header {
            font-size: .8125rem;
            padding: .625rem;
          }
          .modal-body {
            padding: 0 .625rem .75rem;
            white-space: normal;
          }
        }
      }
    `},(0,o.jsx)("div",{className:"modal-content"},f()))})),function(e){e.None="",e.Init="init",e.Loading="loading",e.Loaded="loaded",e.Warning="warning",e.Error="error"}(B||(B={}));const A=(0,T.withTheme)((e=>{const{theme:t,className:a,title:n,statusType:s}=e;return s&&(0,o.jsx)("div",{className:`${null!=a?a:""} ui-unit-status-indicator ui-unit-status-indicator_status-type-${s}`,title:n,css:o.css`
    &.ui-unit-status-indicator {
      display: flex;
      &.ui-unit-status-indicator_status-type-loading {
        &:before {
          @keyframes loading {
            0% {transform: rotate(0deg); };
            100% {transform: rotate(360deg)};
          }
          content: '';
          width: 1rem;
          height: 1rem;
          display: block;
          border: 1px solid ${null===(i=null===(l=null===(r=null==t?void 0:t.colors)||void 0===r?void 0:r.palette)||void 0===l?void 0:l.light)||void 0===i?void 0:i[400]};
          border-radius: 50%;
          border-top: 1px solid ${null===(d=null===(u=null===(c=null==t?void 0:t.colors)||void 0===c?void 0:c.palette)||void 0===u?void 0:u.primary)||void 0===d?void 0:d[600]};
          box-sizing: border-box;
          animation: loading 2s infinite linear;
          margin-right: .25rem;
        }
      }
    }
  `});var r,l,i,c,u,d}));function _(e){const{widgetId:t,useDataSourceId:a}=e;return o.ReactRedux.useSelector((e=>{var n;let s;return s=window.jimuConfig.isBuilder?e.appStateInBuilder.appConfig:e.appConfig,(null!==(n=s.widgets[t].useDataSources)&&void 0!==n?n:[]).some((e=>e.dataSourceId===a))}))}function F(e){var t,a,n;const{widgetId:s,useDataSource:l,onStatusChange:i,onDataSourceCreated:c,showMessage:u=!1}=e,d=o.hooks.useTranslation(r.defaultMessages),p=_({widgetId:s,useDataSourceId:l.dataSourceId}),[f,m]=o.React.useState(null),[g,v]=o.React.useState(null),h=o.React.useCallback((e=>{if(e){const{status:t,instanceStatus:a}=e;a===o.DataSourceStatus.NotCreated?(m("creating"),null==i||i(!1)):a===o.DataSourceStatus.CreateError||t===o.DataSourceStatus.LoadError?(m("error"),null==i||i(!1)):t===o.DataSourceStatus.NotReady?(m("warning"),null==i||i(!1)):(m(null),null==i||i(!0))}}),[i]),y=o.React.useCallback((e=>{v(e),null==c||c(e)}),[c]),x=o.React.useCallback((()=>{v(null),m("error"),null==i||i(!1)}),[i]);let R,w,I;if("creating"===f)R=b(),w=d("loading");else if(p&&"error"!==f){if("warning"===f){const e=null===(t=null==g?void 0:g.getOriginDataSources())||void 0===t?void 0:t[0],s=null==e?void 0:e.getLabel(),r=o.appConfigUtils.getWidgetIdByOutputDataSource(l),i=null===(n=((null===(a=null===window||void 0===window?void 0:window.jimuConfig)||void 0===a?void 0:a.isBuilder)?(0,o.getAppStore)().getState().appStateInBuilder:(0,o.getAppStore)().getState()).appConfig.widgets[r])||void 0===n?void 0:n.label;I="var(--warning-700)",R=S(),w=d("outputDataIsNotGenerated",{outputDsLabel:null!=s?s:"",sourceWidgetName:null!=i?i:""})}}else R=b(),w=d("dataSourceCreateError"),I="var(--danger-500)";return(0,o.jsx)(o.React.Fragment,null,p&&(0,o.jsx)(o.DataSourceComponent,{useDataSource:l,onDataSourceInfoChange:h,onDataSourceCreated:y,onCreateDataSourceFailed:x}),"creating"===f&&(0,o.jsx)(A,{statusType:B.Loading,title:w}),(!p||"error"===f||"warning"===f)&&(0,o.jsx)("div",{className:"d-flex align-items-center"},(0,o.jsx)(r.Tooltip,{title:w},(0,o.jsx)(r.Button,{size:"sm",type:"tertiary",icon:!0},(0,o.jsx)(r.Icon,{icon:R,color:I}))),u&&(0,o.jsx)("div",{className:"status-message"},w)))}const z=o.css`
  font-weight: 500;
  font-size: 14px;
`;function q(e){const{icon:t,name:a}=e;return(0,o.jsx)("div",{className:"d-flex align-items-center text-truncate",css:z},t&&(0,o.jsx)(r.Icon,{className:"query-task-icon mr-2",icon:t.svg}),(0,o.jsx)("div",{className:"text-truncate",title:a},a))}const U={icon:null,displayLabel:!0,sqlExprObj:null,useAttributeFilter:!0,useSpatialFilter:!0,spatialMapWidgetIds:[],spatialFilterTypes:[],spatialInteractiveCreateToolTypes:[e.Point,e.Polyline,e.Polygon,e.Rectangle,e.Circle],spatialInteractiveEnableBuffer:!1,spatialInteractiveBufferDistance:0,spatialInteractiveBufferUnit:i.Meters,spatialRelations:[s.Intersect],spatialRelationUseDataSources:[],spatialRelationEnableSelectTool:!1,spatialRelationEnableBuffer:!1,spatialRelationBufferDistance:0,spatialRelationBufferUnit:i.Meters,resultListDirection:p.Vertical,resultPagingStyle:f.MultiPage,resultFieldsType:m.PopupSetting,resultSymbolType:v.DefaultSymbol,resultCustomSymbol:{angle:0,color:[255,255,255,255],outline:{color:[255,255,255,255],style:"esriSLSSolid",type:"esriSLS",width:1},size:6,style:"esriSMSCircle",type:"esriSMS",xoffset:0,yoffset:0},resultAllowChangeSymbol:!1,allowExport:!1,sortOptions:[],itemSizeMap:{arrangementHorizontalPopper:{minSize:{width:300,height:300},defaultSize:{width:360,height:480}}}},{iconMap:V}=O(),$=o.css`
  height: 32px;
`;function G(e){const{widgetId:t,queryItem:a,onStatusChange:n}=e,[s,l]=o.React.useState(!0),i=Object.assign({},U,a),{icon:c,name:u,useDataSource:d}=i;return(0,o.jsx)("div",{className:"d-flex align-items-center pl-2 pr-1 w-100",css:$},(0,o.jsx)(q,{icon:c,name:u}),(0,o.jsx)("div",{className:"ml-auto"},(0,o.jsx)(F,{widgetId:t,useDataSource:d,onStatusChange:e=>{l(e),n(e)}})),(0,o.jsx)(r.Button,{"aria-label":u,className:"ml-2",size:"sm",type:"tertiary",disabled:!s,icon:!0},(0,o.jsx)(r.Icon,{size:16,icon:V.arrowRight,autoFlip:!0})))}const Z=e=>{const t=window.SVG,{className:a}=e,n=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a}(e,["className"]),s=(0,o.classNames)("jimu-icon jimu-icon-component",a);return t?o.React.createElement(t,Object.assign({className:s,src:N()},n)):o.React.createElement("svg",Object.assign({className:s},n))};var W=u(26826),H=u(15506);const J=o.React.createContext({resetSymbol:null});function K(e){const{distance:t=0,unit:a=i.Meters,onBufferChange:n}=e,s=o.hooks.useTranslation(h),[l,c]=o.React.useState(t),[u,d]=o.React.useState(a),p=o.React.useContext(J),f=o.React.useRef(p.resetSymbol);o.React.useEffect((()=>{let e=!1;t!==l&&(c(t),e=!0),a!==u&&(d(a),e=!0),e&&n(t,a)}),[t,a]),o.React.useEffect((()=>{p.resetSymbol&&p.resetSymbol!==f.current&&(f.current=p.resetSymbol,c(t),d(a),n(t,a))}),[p.resetSymbol,t,a,n]);const m=o.React.useCallback((e=>{c(e)}),[]),g=o.React.useCallback((e=>{c(e),n(e,u)}),[n,u]),v=o.React.useCallback((e=>{d(e.target.value),n(l,e.target.value)}),[n,l]);return(0,o.jsx)(o.React.Fragment,null,(0,o.jsx)(r.NumericInput,{"aria-label":s("bufferDistance"),className:"mr-1",value:l,onChange:m,onAcceptValue:g}),(0,o.jsx)(r.Select,{"aria-label":s("unit"),value:u,onChange:v},Object.values(i).map((e=>(0,o.jsx)("option",{key:e,value:e},s(`unit_${e}`))))))}const Q=o.css`margin-top: 0.75rem;`;function Y(e){const{onSelectionChange:t,useDataSources:a,spatialRelations:n,enableBuffer:l,bufferDistance:i,bufferUnit:c,onBufferChange:u,onRelationChange:d}=e,p=o.hooks.useTranslation(h),[f,m]=o.React.useState(a[0]),[g,v]=o.React.useState(0),[y,S]=o.React.useState(null==n?void 0:n[0]),x=o.React.useContext(J),b=o.React.useRef(x.resetSymbol),R=o.React.useMemo((()=>Object.entries(s).map((([e,t])=>({value:t,label:p(`spatialRelation_${e}`)})))),[p]);o.hooks.useEffectOnce((()=>{(null==n?void 0:n.length)>0&&d(n[0]),l&&u(i,c)})),o.React.useEffect((()=>{x.resetSymbol&&x.resetSymbol!==b.current&&(b.current=x.resetSymbol,S(null==n?void 0:n[0]),d(null==n?void 0:n[0]))}),[x.resetSymbol,d,n]),o.React.useEffect((()=>{n?n.includes(y)||(S(n[0]),d(n[0])):S(null)}),[n,y,d]);const w=o.React.useCallback((e=>{const t=a.find((t=>t.dataSourceId===e.target.value));m((0,o.Immutable)(t))}),[a]),I=o.React.useCallback((()=>{const e=o.DataSourceManager.getInstance().getDataSource(f.dataSourceId),a=null==e?void 0:e.getSelectedRecords();if((null==a?void 0:a.length)>0){const e=a.map((e=>e.getGeometry()));t(e),v(a.length)}else t(null),v(0)}),[f.dataSourceId,t]),C=o.React.useCallback((e=>{S(e.target.value),d(e.target.value)}),[d]);return(0,o.jsx)("div",null,(0,o.jsx)("div",{css:Q},p("chooseFilterLayer")),(0,o.jsx)(r.Select,{"aria-label":p("chooseFilterLayer"),value:f.dataSourceId,onChange:w},a.map((e=>{const t=o.DataSourceManager.getInstance().getDataSource(e.dataSourceId);return(0,o.jsx)("option",{key:e.dataSourceId,value:e.dataSourceId},null==t?void 0:t.getLabel())}))),(0,o.jsx)("div",{className:"mt-1 font-italic",css:o.css`color: var(--dark-800);`},p("selectedRecords",{num:g})),(null==n?void 0:n.length)>0&&(0,o.jsx)("div",{css:Q},(0,o.jsx)("div",{className:"text-truncate mb-0"},p("relationship")),(0,o.jsx)(r.Select,{"aria-label":p("relationship"),value:y,onChange:C},n.map((e=>{return(0,o.jsx)("option",{key:e,value:e},(t=e,R.find((e=>e.value===t)).label));var t})))),l&&(0,o.jsx)("div",{role:"group","aria-label":p("bufferDistance"),css:Q},(0,o.jsx)("div",{className:"text-truncate"},p("bufferDistance")),(0,o.jsx)("div",{className:"d-flex mt-1"},(0,o.jsx)(K,{distance:i,unit:c,onBufferChange:u}))),(0,o.jsx)(o.DataSourceComponent,{useDataSource:f,onDataSourceInfoChange:I}))}function X(e){const{onGeometryChange:t,mapWidgetIds:a}=e,[n,s]=o.React.useState(null),r=o.React.useRef(null);o.React.useEffect((()=>{if(null==n?void 0:n.view){const e=n.view.watch("extent",(e=>{r.current?t(r.current.fromExtent(e)):(0,W.loadArcGISJSAPIModules)(["esri/geometry/Polygon"]).then((a=>{r.current=a[0],t(r.current.fromExtent(e))}))}));return t(n.view.extent),()=>{e.remove()}}}),[n,t]);const l=o.React.useCallback((e=>{s(null!=(null==e?void 0:e.view)?e:null)}),[]);return(0,o.jsx)(o.React.Fragment,null,null==a?void 0:a.map(((e,t)=>(0,o.jsx)(W.JimuMapViewComponent,{key:t,useMapWidgetId:e,onActiveViewChange:l}))))}var ee=u(58290);const te={[e.Point]:{drawToolName:"point",esriClassName:"esri-icon-point",toolIndex:0},[e.Polyline]:{drawToolName:"polyline",esriClassName:"esri-icon-polyline",toolIndex:4},[e.Polygon]:{drawToolName:"polygon",esriClassName:"esri-icon-polygon",toolIndex:2},[e.Rectangle]:{drawToolName:"rectangle",esriClassName:"esri-icon-checkbox-unchecked",toolIndex:1},[e.Circle]:{drawToolName:"circle",esriClassName:"esri-icon-radio-unchecked",toolIndex:3}};function ae(e){const{toolTypes:t=[],jimuMapView:a,onDrawEnd:n}=e,s=o.hooks.useTranslation(h),[l,i]=o.React.useState(null),c=o.React.useRef(null),u=o.React.useRef(null),[d,p]=o.React.useState(!1),f=o.React.useMemo((()=>({createTools:Object.entries(te).reduce(((e,[a,n])=>Object.assign(Object.assign({},e),{[n.drawToolName]:t.includes(a)})),{point:!1}),selectionTools:{"lasso-selection":!1,"rectangle-selection":!1},settingsMenu:!1,undoRedoMenu:!1})),[t]);o.hooks.useEffectOnce((()=>{o.moduleLoader.loadModule("jimu-ui/advanced/map").then((e=>{i(e)}))}));const m=o.React.useCallback((e=>{c.current=e.getGraphicsLayer}),[]),g=o.React.useCallback((()=>{c.current&&c.current().removeAll()}),[]),v=o.React.useCallback((e=>{u.current=e,n(e,c.current,d)}),[n,d]),y=o.React.useCallback((()=>{u.current=null,n(null)}),[n]),S=o.React.useCallback((e=>{u.current&&n(u.current,c.current,e.target.checked),p(e.target.checked)}),[n]),x=null==l?void 0:l.JimuDraw;return x?Object.keys(f.createTools).some((e=>f.createTools[e]))?(0,o.jsx)("div",null,(0,o.jsx)(x,{jimuMapView:a,disableSymbolSelector:!0,drawingOptions:{creationMode:ee.JimuDrawCreationMode.Single,updateOnGraphicClick:!1,visibleElements:f},uiOptions:{isHideBorder:!0},onJimuDrawCreated:m,onDrawingStarted:g,onDrawingFinished:v,onDrawingCleared:y}),(0,o.jsx)("label",{className:"d-flex align-items-center"},(0,o.jsx)(r.Checkbox,{checked:d,onChange:S,className:"mr-2"}),s("clearDrawing"))):null:(0,o.jsx)(A,{statusType:B.Loading})}var ne=function(e,t,a,n){return new(a||(a=Promise))((function(s,o){function r(e){try{i(n.next(e))}catch(e){o(e)}}function l(e){try{i(n.throw(e))}catch(e){o(e)}}function i(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,l)}i((n=n.apply(e,t||[])).next())}))};function se(e){const{onGeometryChange:t,createToolTypes:a,mapWidgetIds:n,enableBuffer:s,bufferDistance:r,bufferUnit:l,onBufferChange:i}=e,[c,u]=o.React.useState(null),d=o.hooks.useTranslation(h),p=o.React.useContext(J),f=o.React.useRef(p.resetSymbol),m=o.React.useRef(null),g=o.React.useRef(null),v=o.React.useRef(null),y=o.React.useRef(null),S=o.React.useRef(r),x=o.React.useRef(l),b=o.React.useRef(null);o.hooks.useEffectOnce((()=>{s&&o.lodash.defer((()=>{i(r,l)})),(0,W.loadArcGISJSAPIModules)(["esri/Graphic"]).then((e=>{const t=e[0];b.current=new t({symbol:{type:"simple-fill",color:[51,51,204,.5],style:"solid",outline:{color:[51,51,204,.8],width:1}}})}))}));const R=o.React.useCallback((()=>ne(this,void 0,void 0,(function*(){var e,t,a,n,r,l;if(!y.current||!s||0===S.current)return void(b.current.geometry=null);const i=("point"===(null===(e=y.current)||void 0===e?void 0:e.type)||"multipoint"===(null===(t=y.current)||void 0===t?void 0:t.type))&&S.current<0,c="polyline"===(null===(a=y.current)||void 0===a?void 0:a.type)&&S.current<0;if(i||c)return void(b.current.geometry=null);const u=y.current;if((null===(n=u.spatialReference)||void 0===n?void 0:n.isGeographic)&&!u.spatialReference.isWGS84){const e=o.utils.getGeometryService();if(!v.current){const e=yield(0,W.loadArcGISJSAPIModules)(["esri/rest/geometryService","esri/rest/support/BufferParameters"]);v.current={geometryService:e[0],bufferParameters:e[1]}}const{geometryService:t,bufferParameters:a}=v.current,n=yield t.buffer(e,new a({distances:[S.current],unit:o.lodash.kebabCase(x.current),geodesic:!0,bufferSpatialReference:u.spatialReference,outSpatialReference:u.spatialReference,geometries:[u]}));b.current.geometry=n[0]}else g.current||(g.current=yield(0,o.loadArcGISJSAPIModule)("esri/geometry/geometryEngine")),(null===(r=u.spatialReference)||void 0===r?void 0:r.isWGS84)||(null===(l=u.spatialReference)||void 0===l?void 0:l.isWebMercator)?b.current.geometry=g.current.geodesicBuffer(u,S.current,o.lodash.kebabCase(x.current)):b.current.geometry=g.current.buffer(u,S.current,o.lodash.kebabCase(x.current))}))),[s]);o.React.useEffect((()=>{p.resetSymbol&&p.resetSymbol!==f.current&&(f.current=p.resetSymbol,m.current&&m.current().removeAll(),t(null))}),[p.resetSymbol,t]);const w=o.React.useCallback((e=>{const a=m.current&&m.current();a&&(a.removeAll(),t(null)),u(null!=(null==e?void 0:e.view)?e:null)}),[t]),I=o.React.useCallback(((e,t)=>{S.current=e,x.current=t,R(),i(e,t)}),[i,R]),C=o.React.useCallback(((e,a,n)=>{m.current=a;const s=m.current&&m.current();y.current=null==e?void 0:e.geometry,R().then((()=>{b.current.geometry&&(null==s||s.add(b.current))})),t(null==e?void 0:e.geometry,s,e,n)}),[t,R]);return(0,o.jsx)(o.React.Fragment,null,null==n?void 0:n.map(((e,t)=>(0,o.jsx)(W.JimuMapViewComponent,{key:t,useMapWidgetId:e,onActiveViewChange:w}))),(null==c?void 0:c.view)&&(0,o.jsx)(o.React.Fragment,null,(0,o.jsx)(ae,{jimuMapView:c,toolTypes:a,onDrawEnd:C}),s&&(0,o.jsx)("div",{role:"group","aria-label":d("bufferDistance"),css:o.css`margin-top: 0.75rem;`},(0,o.jsx)("div",{className:"text-truncate"},d("bufferDistance")),(0,o.jsx)("div",{className:"d-flex mt-1"},(0,o.jsx)(K,{distance:r,unit:l,onBufferChange:I})))))}var oe=u(88866),re=u.n(oe);const le=e=>{const t=window.SVG,{className:a}=e,n=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a}(e,["className"]),s=(0,o.classNames)("jimu-icon jimu-icon-component",a);return t?o.React.createElement(t,Object.assign({className:s,src:re()},n)):o.React.createElement("svg",Object.assign({className:s},n))};function ie(e){var t;const{label:a,desc:s,filterTypes:l,mapWidgetIds:c,onFilterChange:u,onRelationChange:d,onBufferChange:p,useDataSources:f,spatialRelations:m,dsEnableBuffer:g,dsBufferDistance:v,dsBufferUnit:y,drawEnableBuffer:S,drawBufferDistance:x,drawBufferUnit:b,createToolTypes:R}=e,w=o.hooks.useTranslation(h),I=o.React.useRef(null),C=o.ReactRedux.useSelector((e=>{if((null==c?void 0:c.length)>0){const t=c[0];return null!=e.appConfig.widgets[t]}return!1})),j=o.React.useMemo((()=>C&&((null==l?void 0:l.includes(n.CurrentMapExtent))||(null==l?void 0:l.includes(n.InteractiveDrawMode)))),[l,C]),N=o.React.useMemo((()=>{const e=[];return(null==f?void 0:f.length)>0&&e.push({value:"data",label:w("featureFromDs")}),j&&(null==l?void 0:l.includes(n.CurrentMapExtent))&&e.push({value:"map",label:w(`spatialFilterType_${n.CurrentMapExtent}`)}),j&&(null==l?void 0:l.includes(n.InteractiveDrawMode))&&e.push({value:"draw",label:w(`spatialFilterType_${n.InteractiveDrawMode}`)}),e}),[j,f,w,l]),[M,D]=o.React.useState(null===(t=null==N?void 0:N[0])||void 0===t?void 0:t.value);o.React.useEffect((()=>{var e;"none"===M||N.find((e=>e.value===M))||D(null===(e=null==N?void 0:N[0])||void 0===e?void 0:e.value)}),[M,N]),o.React.useEffect((()=>{"map"!==M&&"draw"!==M&&"none"!==M||(d(null),p(0,i.Meters),u({geometry:null})),"data"===M&&null==I.current&&u({geometry:null})}),[M,d,p,u]);const O=o.React.useCallback((e=>{D(e.target.value)}),[]),P=o.React.useCallback(((e,t,a,n)=>{u({geometry:e,graphic:a,layer:t,clearAfterApply:n})}),[u]),E=o.React.useCallback((e=>{I.current=e,u({geometry:e})}),[u]);return(null==f?void 0:f.length)>0||j?(0,o.jsx)("div",{role:"group",className:"px-3","aria-label":a},(0,o.jsx)("div",{className:(0,o.classNames)("form-title my-2 d-flex align-items-center",{"d-none":!a&&!s})},a&&(0,o.jsx)("div",{className:"mr-2"},a),s&&(0,o.jsx)(r.Tooltip,{placement:"bottom",css:o.css`white-space: pre-line;`,title:s},(0,o.jsx)(r.Button,{size:"sm",icon:!0,type:"tertiary"},(0,o.jsx)(le,{color:"var(--primary)",size:"s"})))),N.length>0&&(0,o.jsx)("div",null,(0,o.jsx)("div",null,w("chooseFilterType")),(0,o.jsx)(r.Select,{"aria-label":w("chooseFilterType"),css:o.css`height: 32px;`,value:M,onChange:O},(0,o.jsx)("option",{key:"-",value:"none"},"-"),N.map((e=>(0,o.jsx)("option",{key:e.value,value:e.value},e.label))))),"data"===M&&(0,o.jsx)(Y,{enableBuffer:g,bufferDistance:v,bufferUnit:y,spatialRelations:m,useDataSources:f,onSelectionChange:E,onRelationChange:d,onBufferChange:p}),"map"===M&&(0,o.jsx)(X,{mapWidgetIds:c,createToolTypes:R,onGeometryChange:P}),"draw"===M&&(0,o.jsx)(se,{enableBuffer:S,bufferDistance:x,bufferUnit:b,mapWidgetIds:c,createToolTypes:R,onGeometryChange:P,onBufferChange:p})):null}var ce=u(74758);const ue=o.React.createContext(null);function de(){const e=o.React.useContext(ue);let t,a;if(e.includes(":")){const n=e.split(":");t=n[0],a=n[1]}return o.ReactRedux.useSelector((e=>{var n,s,o,r;const l=null===(s=null===(n=e.appConfig.layouts[t])||void 0===n?void 0:n.content)||void 0===s?void 0:s[a];return(null===(r=null===(o=null==l?void 0:l.setting)||void 0===o?void 0:o.autoProps)||void 0===r?void 0:r.height)===ce.LayoutItemSizeModes.Auto}))}const pe=e=>o.css`
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    .form-title {
      color: var(--dark-800);
      font-weight: 500;
      font-size: 13px;
      line-height: 18px;
    }
    .query-form__content {
      flex: 1 1 ${e?"auto":0};
      max-height: ${e?"61.8vh":"none"};
      overflow: auto;
    }
  `;function fe(e){const{widgetId:t,configId:a,outputDS:n,spatialFilterEnabled:l,datasourceReady:i,onFormSubmit:c,dataActionFilter:u}=e,d=o.hooks.usePrevious(u),p=o.ReactRedux.useSelector((e=>e.appConfig.widgets[t].config.queryItems.find((e=>e.configId===a)))),f=Object.assign({},U,p),m=o.hooks.useTranslation(h),[g,v]=o.React.useState(null),{useAttributeFilter:y,useSpatialFilter:S,spatialFilterTypes:x,sqlExprObj:b,spatialMapWidgetIds:R,spatialInteractiveCreateToolTypes:w,spatialRelationUseDataSources:I,spatialRelations:C,spatialRelationEnableBuffer:j,spatialRelationBufferDistance:N,spatialRelationBufferUnit:M,spatialInteractiveEnableBuffer:D,spatialInteractiveBufferDistance:O,spatialInteractiveBufferUnit:P,attributeFilterLabel:E=m("attributeFilter"),spatialFilterLabel:k=m("spatialFilter"),attributeFilterDesc:T,spatialFilterDesc:L}=f,[B,A]=o.React.useState(b),_=o.React.useRef(null),F=o.React.useRef(s.Intersect),z=o.React.useRef(null),q=de(),V=o.React.useRef((0,H.getShownClauseNumberByExpression)(b)),$=null==n?void 0:n.getOriginDataSources()[0];o.React.useEffect((()=>{b?(V.current=(0,H.getShownClauseNumberByExpression)(b),A(b)):(V.current=0,A(null))}),[b]);const G=o.React.useCallback((()=>{var e,t,a;null===(e=null==n?void 0:n.selectRecordsByIds)||void 0===e||e.call(n,[]);let o=F.current;(null===(t=_.current)||void 0===t?void 0:t.geometry)&&null==o&&(o=s.Intersect),Array.isArray(null===(a=_.current)||void 0===a?void 0:a.geometry)?(0,W.loadArcGISJSAPIModules)(["esri/geometry/geometryEngine"]).then((e=>{const t=e[0].union(_.current.geometry);c(B,Object.assign(Object.assign({},_.current),{geometry:t,relation:o,buffer:z.current}))})):c(B,Object.assign(Object.assign({},_.current),{relation:o,buffer:z.current}))}),[c,B]);o.React.useEffect((()=>{u&&u.where!==(null==d?void 0:d.where)&&G()}),[u,G]);const Z=o.React.useCallback((()=>{V.current=(0,H.getShownClauseNumberByExpression)(b),A(b),v(Symbol())}),[b]),K=o.React.useCallback((e=>{V.current=(0,H.getShownClauseNumberByExpression)(e),A(e)}),[]),Q=o.React.useCallback((e=>{_.current=e}),[]),Y=o.React.useCallback((e=>{F.current=e}),[]),X=o.React.useCallback(((e,t)=>{z.current={distance:e,unit:t}}),[]),ee=y&&null!=b,te=l&&S&&(x.length>0||(null==I?void 0:I.length)>0);return(0,o.jsx)(J.Provider,{value:{resetSymbol:g}},(0,o.jsx)("div",{className:"query-form",css:pe(q)},(0,o.jsx)("div",{className:"query-form__content my-2"},ee&&(0,o.jsx)("div",{role:"group",className:"px-3","aria-label":E},(0,o.jsx)("div",{className:(0,o.classNames)("form-title my-2 d-flex align-items-center",{"d-none":!E&&!T})},E&&(0,o.jsx)("div",{className:"mr-2"},E),T&&(0,o.jsx)(r.Tooltip,{placement:"bottom",css:o.css`white-space: pre-line;`,title:T},(0,o.jsx)(r.Button,{size:"sm",icon:!0,type:"tertiary"},(0,o.jsx)(le,{color:"var(--primary)",size:"s"})))),$&&(0,o.jsx)(H.SqlExpressionRuntime,{widgetId:t,dataSource:$,expression:B,onChange:K})),ee&&te&&(0,o.jsx)("hr",{className:"m-3",css:o.css`border: none; height: 1px; background-color: var(--light-300);`}),te&&(0,o.jsx)(ie,{widgetId:t,label:k,desc:L,filterTypes:x,mapWidgetIds:R,createToolTypes:w,onFilterChange:Q,onRelationChange:Y,onBufferChange:X,spatialRelations:C,dsEnableBuffer:j,dsBufferDistance:N,dsBufferUnit:M,drawEnableBuffer:D,drawBufferDistance:O,drawBufferUnit:P,useDataSources:I})),(0,o.jsx)("div",{className:"query-form__actions px-3 d-flex align-items-center"},(0,o.jsx)(r.Button,{className:"active ml-auto",disabled:!i,onClick:G},m("apply")),(V.current>0||te)&&(0,o.jsx)(r.Button,{className:"ml-2",onClick:Z},m("reset")))))}var me=u(98940),ge=u.n(me);const ve=e=>{const t=window.SVG,{className:a}=e,n=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a}(e,["className"]),s=(0,o.classNames)("jimu-icon jimu-icon-component",a);return t?o.React.createElement(t,Object.assign({className:s,src:ge()},n)):o.React.createElement("svg",Object.assign({className:s},n))};var he=u(10119),ye=u.n(he);const Se=e=>{const t=window.SVG,{className:a}=e,n=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a}(e,["className"]),s=(0,o.classNames)("jimu-icon jimu-icon-component",a);return t?o.React.createElement(t,Object.assign({className:s,src:ye()},n)):o.React.createElement("svg",Object.assign({className:s},n))};var xe;!function(e){e.Pending="Pending",e.Fulfilled="Fulfilled",e.Rejected="Rejected"}(xe||(xe={}));const be=o.css`
  border: 1px solid var(--light-200);
  .esri-widget__heading {
    font-size: 14px;
    font-weight: 500;
    margin: 0;
    color: var(--black);
  }

  .esri-feature__content-element {
    padding: 0;
  }

  .jimu-btn.expanded {
    align-self: flex-start;
  }

  .esri-feature.esri-widget {
    background-color: transparent;
  }
`;class Re extends o.React.PureComponent{constructor(e){super(e),this.toggleExpanded=e=>{e.stopPropagation(),this.setState({showContent:!this.state.showContent})};const{togglable:t=!1,expandByDefault:a}=this.props;this.state={showContent:!t||a,loadStatus:xe.Pending}}componentDidMount(){this.createFeature()}componentDidUpdate(){this.feature&&(this.feature.graphic.popupTemplate=this.props.popupTemplate,this.feature.visibleElements=this.getVisibleElements())}destoryFeature(){this.feature&&!this.feature.destroyed&&this.feature.destroy()}getVisibleElements(){const{togglable:e=!1}=this.props,{showContent:t}=this.state,a=!e||t;return{title:!0,content:{fields:a,text:a,media:a,attachments:a},lastEditedInfo:!1}}createFeature(){let e;return e=this.Feature?Promise.resolve():(0,W.loadArcGISJSAPIModules)(["esri/widgets/Feature"]).then((e=>{[this.Feature]=e})),e.then((()=>{var e,t,a;const n=document&&document.createElement("div");n.className="jimu-widget",this.refs.featureContainer.appendChild(n);const s=this.props.dataSource.getOriginDataSources(),o=null===(e=null==s?void 0:s[0])||void 0===e?void 0:e.getRootDataSource();this.destoryFeature(),this.props.graphic.popupTemplate=this.props.popupTemplate,this.feature=new this.Feature({container:n,defaultPopupTemplateEnabled:!0,spatialReference:(null===(a=null===(t=this.props.dataSource)||void 0===t?void 0:t.layer)||void 0===a?void 0:a.spatialReference)||null,map:(null==o?void 0:o.map)||null,graphic:this.props.graphic,visibleElements:this.getVisibleElements()})})).then((()=>{this.setState({loadStatus:xe.Fulfilled})}))}render(){const{togglable:e=!1,intl:t}=this.props,{showContent:a}=this.state;return(0,o.jsx)("div",{className:"feature-info-component d-flex align-items-center p-2",css:be},e&&(0,o.jsx)(r.Button,{"aria-label":t.formatMessage({id:a?"collapse":"expand"}),className:(0,o.classNames)("p-0 jimu-outline-inside",{expanded:a}),type:"tertiary",icon:!0,size:"sm",onClick:this.toggleExpanded},a?(0,o.jsx)(Se,{size:"s"}):(0,o.jsx)(ve,{size:"s",autoFlip:!0})),(0,o.jsx)("div",{className:"flex-grow-1",ref:"featureContainer"}))}}const we=(0,o.injectIntl)(Re),Ie=o.css`
  overflow: auto;
  flex-flow: row;
  cursor: pointer;
  flex-shrink: 0;
  min-height: 2rem;
  &.selected {
    .feature-info-component {
      border-color: var(--primary-500);
      border-width: 2px;
    }
  }
`,Ce=e=>{const{widgetId:t,data:a,dataSource:n,popupTemplate:s,expandByDefault:r=!1}=e,l=o.ReactRedux.useSelector((e=>{var t,s,o;return null===(o=null===(s=null===(t=e.dataSourcesInfo)||void 0===t?void 0:t[n.id])||void 0===s?void 0:s.selectedIds)||void 0===o?void 0:o.includes(a.getId())})),i=o.ReactRedux.useSelector((e=>e.appConfig.widgets[t].config.resultListDirection!==p.Horizontal)),c=o.React.useCallback((()=>{var e,s;const r=a.getId(),l=(null!==(e=n.getSelectedRecordIds())&&void 0!==e?e:[]).includes(r)?[]:[a];o.MessageManager.getInstance().publishMessage(new o.DataRecordsSelectionChangeMessage(t,l)),null===(s=n.selectRecordsByIds)||void 0===s||s.call(n,l.map((e=>e.getId())))}),[t,a,n]),u=o.React.useCallback((e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),c())}),[c]);return(0,o.jsx)("div",{className:(0,o.classNames)("query-result-item",{selected:l}),onClick:c,onKeyUp:u,css:Ie,role:"option","aria-selected":l,tabIndex:0},(0,o.jsx)(we,{graphic:a.feature,popupTemplate:s,togglable:i,expandByDefault:r,dataSource:n}))};var je=function(e,t,a,n){return new(a||(a=Promise))((function(s,o){function r(e){try{i(n.next(e))}catch(e){o(e)}}function l(e){try{i(n.throw(e))}catch(e){o(e)}}function i(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,l)}i((n=n.apply(e,t||[])).next())}))};function Ne(e,t){return je(this,void 0,void 0,(function*(){const{resultFieldsType:a,resultDisplayFields:n,resultTitleExpression:s=""}=t,o=e.getOriginDataSources()[0].getPopupInfo();if(a===m.SelectAttributes){let t=n;if(null==n){const a=e.getSchema();t=(null==a?void 0:a.fields)?Object.values(a.fields).map((e=>e.jimuName)):[]}if(o){const e=[];return t.forEach((t=>{const a=o.fieldInfos.find((e=>e.fieldName===t));a?(a.visible=!0,e.push(a)):e.push({fieldName:t,label:t})})),{fieldInfos:e,content:[{type:"fields"}],title:s}}return{fieldInfos:t.map((e=>({fieldName:e,label:e}))),content:[{type:"fields"}],title:s}}return null}))}function Me(e,t,a,n){return je(this,void 0,void 0,(function*(){const t=a.getPopupInfo(),s=a.getLayerDefinition(),r=(e=>{return e.length?e:[{fieldName:null!==(t=null==s?void 0:s.objectIdField)&&void 0!==t?t:"objectid",label:"OBJECTID",tooltip:"",visible:!0}];var t})(((null==t?void 0:t.fieldInfos)||[]).filter((e=>e.visible))),l=yield a.load(n,{widgetId:e}),i=a.getOriginDataSources()[0],c=yield function(e){return je(this,void 0,void 0,(function*(){if(e.layer)return yield e.layer.load(),e.layer;{const t=yield e.createJSAPILayerByDataSource();return yield t.load(),t}}))}(i);l.forEach((e=>{const t=e.feature;t.sourceLayer=c.associatedLayer||c,t.layer=t.sourceLayer}));const u={records:l,fields:r.map((e=>e.fieldName))},d=new o.DataRecordSetChangeMessage(e,o.RecordSetChangeType.CreateUpdate,[{records:a.getRecords(),fields:u.fields,dataSource:a,name:a.id}]);return o.MessageManager.getInstance().publishMessage(d),u}))}var De=function(e,t,a,n){return new(a||(a=Promise))((function(s,o){function r(e){try{i(n.next(e))}catch(e){o(e)}}function l(e){try{i(n.throw(e))}catch(e){o(e)}}function i(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,l)}i((n=n.apply(e,t||[])).next())}))};const{useRef:Oe,useState:Pe}=o.React,Ee=e=>o.css`
    display: flex;
    flex: 1 1 ${e?"auto":0};
    overflow: auto;
    max-height: ${e?"calc(61.8vh - 100px)":"none"};

    .query-result-item + .query-result-item {
      margin-left: 0.5rem;
      margin-top: 0;
    }

    &.vertical {
      flex-direction: column;
      .list-items {
        position: relative;
        flex-direction: column;
      }

      .feature-info-component {
        width: 100%;
      }

      .query-result-item + .query-result-item {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
    .list-items {
      display: flex;
    }
    .lazyload-detector {
      height: 2px;
      width: 2px;
      opacity: 0;
    }
  `;function ke(e){const{widgetId:t,outputDS:a,queryParams:n,resultCount:s,records:l,queryItem:i,direction:c,onRenderDone:u,onEscape:d,defaultPageSize:f=o.CONSTANTS.DEFAULT_QUERY_PAGE_SIZE}=e,[m,g]=Pe(l),[v,h]=Pe(),[y,S]=Pe(B.Init),x=o.hooks.useLatest(m),b=o.hooks.useLatest(s),R=o.hooks.useLatest(y),w=o.hooks.useLatest((null==l?void 0:l.length)===s),I=Oe(0),C=Oe(),j=Oe(null),N=de();o.React.useEffect((()=>{I.current=1,C.current.scrollTop=0,g(l)}),[l]);const M=()=>De(this,void 0,void 0,(function*(){if(w.current||R.current===B.Loading)return;I.current=I.current+1,S(B.Loading);const{records:e}=yield Me(t,0,a,Object.assign(Object.assign({},n),{page:I.current,pageSize:f}));b.current>0&&x.current.length+e.length>=b.current&&(w.current=!0);const s=x.current.concat(e);g(s),null==u||u({dataItems:a.getRecords()}),S(B.Loaded)}));o.React.useEffect((()=>{Ne(a,i).then((e=>{h(e)}))}),[a,i]),o.hooks.useEffectOnce((()=>{const e=null==j?void 0:j.current;if(e){const t=new IntersectionObserver((e=>{e[0].isIntersecting&&M()}));return null==t||t.observe(e),()=>{null==t||t.disconnect()}}}));const D=o.React.useCallback((e=>{"Escape"===e.key&&(e.stopPropagation(),d())}),[d]);return(0,o.jsx)("div",{onKeyUp:D,className:(0,o.classNames)({vertical:c===p.Vertical}),css:Ee(N),ref:C},(0,o.jsx)("div",{className:"list-items px-3",role:"listbox"},null==m?void 0:m.map(((e,n)=>(0,o.jsx)(Ce,{key:e.getId(),data:e,dataSource:a,widgetId:t,popupTemplate:v,expandByDefault:i.resultExpandByDefault})))),(0,o.jsx)("div",{ref:j,className:"lazyload-detector"},"Â "),y===B.Loading&&(0,o.jsx)(r.Loading,{type:r.LoadingType.Donut}))}var Te=function(e,t,a,n){return new(a||(a=Promise))((function(s,o){function r(e){try{i(n.next(e))}catch(e){o(e)}}function l(e){try{i(n.throw(e))}catch(e){o(e)}}function i(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,l)}i((n=n.apply(e,t||[])).next())}))};const{useRef:Le,useState:Be}=o.React,Ae=e=>o.css`
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;

    .list_items {
      flex: 1 1 ${e?"auto":0};
      max-height: ${e?"calc(61.8vh - 100px)":"none"};
      overflow: auto;
      display: flex;
      flex-direction: row;
    }

    .query-result-item + .query-result-item {
      margin-left: 0.5rem;
      margin-top: 0;
    }

    &.vertical {
      .list_items {
        flex-direction: column;
      }
      .feature-info-component {
        width: 100%;
      }
      .query-result-item + .query-result-item {
        margin-top: 0.5rem;
        margin-left: 0;
      }
    }
    .page-size-selector {
      width: auto;
    }

    .query-editable-select {
      .jimu-numeric-input {
        width: 60px;
      }
    }
  `;function _e(e){const{widgetId:t,outputDS:a,queryItem:n,queryParams:s,resultCount:l,records:i,onRenderDone:c,direction:u,onEscape:d,defaultPageSize:f=o.CONSTANTS.DEFAULT_QUERY_PAGE_SIZE}=e,[m,g]=Be(i),[v,h]=Be(),[y,S]=Be(B.Init),x=Le(1),b=Le(f),[R,w]=Be(f),I=de(),C=o.React.useMemo((()=>{const e=[f];return Math.round(f/2)!==e[0]&&e.push(Math.round(f/2)),Math.round(f/5)!==e[1]&&e.push(Math.round(f/5)),e.reverse()}),[f]);o.React.useEffect((()=>{x.current=1,g(i),w(b.current)}),[i]),o.React.useEffect((()=>{Ne(a,n).then((e=>{h(e)}))}),[a,n]);const j=o.React.useCallback(((e,n)=>Te(this,void 0,void 0,(function*(){x.current=e,S(B.Loading);const o=yield Me(t,0,a,Object.assign(Object.assign({},s),{page:e,pageSize:n}));g(o.records),null==c||c({dataItems:a.getRecords(),pageSize:n,page:x.current}),S(B.Loaded)}))),[c,a,n,s,t]);o.React.useEffect((()=>{f!==b.current&&(f<b.current?g(m.slice(0,f)):j(1,f),b.current=f,w(f))}),[f,m,j]);const N=o.React.useCallback((e=>{"Escape"===e.key&&(e.stopPropagation(),d())}),[d]);return(0,o.jsx)("div",{onKeyUp:N,className:(0,o.classNames)({vertical:u===p.Vertical}),css:Ae(I)},(0,o.jsx)("div",{className:"list_items mb-2 px-3",role:"listbox"},null==m?void 0:m.map(((e,s)=>(0,o.jsx)(Ce,{key:e.getId(),data:e,dataSource:a,widgetId:t,popupTemplate:v,expandByDefault:n.resultExpandByDefault})))),y===B.Loading&&(0,o.jsx)(r.Loading,{type:r.LoadingType.Donut}),l>0&&(0,o.jsx)("div",{className:"d-flex justify-content-between align-items-center px-3"},(0,o.jsx)(r.Pagination,{className:"d-flex justify-content-end",disabled:y===B.Loading,current:x.current,totalPage:Math.ceil(l/R),onChangePage:e=>j(e,R),pageSize:R,maxPageSize:1e3,pageSizeOptions:C,onPageSizeChange:e=>{e>0&&(w(e),j(1,e))},showSizeChanger:!0})))}const Fe=e=>{const t=window.SVG,{className:a}=e,n=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a}(e,["className"]),s=(0,o.classNames)("jimu-icon jimu-icon-component",a);return t?o.React.createElement(t,Object.assign({className:s,src:w()},n)):o.React.createElement("svg",Object.assign({className:s},n))},{iconMap:ze}=O(),qe=o.css`
  display: flex;
  flex-direction: column;

  .query-result__header {
    color: var(--dark-800);
    font-weight: 500;
    font-size: 14px;
    line-height: 18px;
  }

  .query-result-container {
    flex: 1 1 0;
    display: flex;
    flex-direction: column;
  }

  .query-result-info {
    height: 18px;
  }
`;function Ue(e){var t;const{queryItem:a,queryParams:n,resultCount:s,maxPerPage:l,records:i,defaultPageSize:c,widgetId:u,outputDS:d,onNavBack:g}=e,v=o.hooks.useTranslation(h),[y,S]=o.React.useState(null),[x,b]=o.React.useState([]),R=o.React.useRef(),w=o.ReactRedux.useSelector((e=>{var t;return null===(t=e.appConfig.widgets[u].enableDataAction)||void 0===t||t})),I=o.ReactRedux.useSelector((e=>e.appConfig.widgets[u].config.resultPagingStyle)),C=o.ReactRedux.useSelector((e=>e.appConfig.widgets[u].config.resultListDirection)),j=Object.assign({},U,a),N=null!=I?I:f.MultiPage,M=null!=C?C:p.Vertical,D=o.React.useMemo((()=>{const e={dataSource:d,type:(null==x?void 0:x.length)>0?"selected":"loaded",records:(null==x?void 0:x.length)>0?x:(null==y?void 0:y.records)||[],name:null==d?void 0:d.getLabel()};return j.resultFieldsType===m.SelectAttributes&&null!=j.resultDisplayFields&&(e.fields=j.resultDisplayFields),e}),[x,d,y,j]);o.hooks.useEffectOnce((()=>{R.current.focus()})),o.React.useEffect((()=>{S({records:i,pageSize:c,page:1})}),[i,c]);const O=o.React.useCallback((({dataItems:e,pageSize:t,page:a})=>{S({records:e,pageSize:t,page:a})}),[]),P=o.React.useCallback((()=>{var e;const t=o.DataSourceManager.getInstance().getDataSource(null==d?void 0:d.id),a=null==t?void 0:t.getSelectedRecords(),n=null!==(e=null==t?void 0:t.getSelectedRecordIds())&&void 0!==e?e:[];let s=!1;s=n.length!==x.length||n.some((e=>null==x.find((t=>t.getId()===e)))),s&&b(a)}),[null==d?void 0:d.id,x]),E=o.React.useCallback((()=>{var e;if(y){if(N===f.LazyLoad)return`${v("featuresDisplayed")}: ${null===(e=null==y?void 0:y.records)||void 0===e?void 0:e.length} / ${s}`;const t=(y.page-1)*y.pageSize+1,a=t+y.pageSize-1;return s>0?`${v("featuresDisplayed")}: ${t} - ${Math.min(a,s)} / ${s}`:`${v("featuresDisplayed")}: 0 - 0 / 0`}return""}),[y,s,v,N]),k=o.React.useMemo((()=>(0,o.Immutable)({dataSourceId:a.outputDataSourceId,mainDataSourceId:a.outputDataSourceId})),[null==a?void 0:a.outputDataSourceId]),T=o.React.useCallback((()=>{var e;null===(e=R.current)||void 0===e||e.focus()}),[]);return(0,o.jsx)("div",{className:"query-result h-100",css:qe,role:"listbox","aria-label":v("results")},(0,o.jsx)(o.DataSourceComponent,{useDataSource:k,onDataSourceInfoChange:P}),(0,o.jsx)("div",{className:"query-result__header d-flex align-items-center px-3"},(0,o.jsx)(r.Button,{ref:R,className:"p-0 mr-2",size:"sm",type:"tertiary",icon:!0,onClick:()=>{g()}},(0,o.jsx)(Fe,{autoFlip:!0})),null!==(t=j.resultsLabel)&&void 0!==t?t:v("results"),(0,o.jsx)(o.React.Fragment,null,(0,o.jsx)(r.Tooltip,{title:v("clearResult"),placement:"bottom"},(0,o.jsx)(r.Button,{className:"ml-auto",icon:!0,size:"sm",type:"tertiary",onClick:()=>{var e;g(!0),S(null),null===(e=d.selectRecordsByIds)||void 0===e||e.call(d,[])},"aria-label":v("clearResult")},(0,o.jsx)(r.Icon,{icon:ze.toolDelete}))),w&&d&&(0,o.jsx)(o.React.Fragment,null,(0,o.jsx)("div",{css:o.css`width: 1px; height: 16px; background-color: var(--light-400);`}),(0,o.jsx)(r.DataActionList,{widgetId:u,dataSets:[D],listStyle:r.DataActionListStyle.Dropdown,buttonSize:"sm",buttonType:"tertiary"})))),(0,o.jsx)("div",{className:"query-result-container mt-1"},(0,o.jsx)("div",{className:"query-result-info mb-2 px-3",role:"alert","aria-live":"polite"},E()),N===f.LazyLoad&&s>0&&(0,o.jsx)(ke,{widgetId:u,queryItem:a,outputDS:d,queryParams:n,resultCount:s,records:i,direction:M,onRenderDone:O,onEscape:T}),N===f.MultiPage&&s>0&&(0,o.jsx)(_e,{widgetId:u,queryItem:a,outputDS:d,queryParams:n,resultCount:s,maxPerPage:l,records:i,direction:M,onRenderDone:O,onEscape:T,defaultPageSize:c})))}var Ve=u(65283),$e=u.n(Ve);const Ge=e=>{const t=window.SVG,{className:a}=e,n=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a}(e,["className"]),s=(0,o.classNames)("jimu-icon jimu-icon-component",a);return t?o.React.createElement(t,Object.assign({className:s,src:$e()},n)):o.React.createElement("svg",Object.assign({className:s},n))};var Ze=function(e,t,a,n){return new(a||(a=Promise))((function(s,o){function r(e){try{i(n.next(e))}catch(e){o(e)}}function l(e){try{i(n.throw(e))}catch(e){o(e)}}function i(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,l)}i((n=n.apply(e,t||[])).next())}))},We=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a};const He=o.css`
  &.wrapped .query-form {
    height: 100%;
  }
  .query-task__content {
    display: flex;
    flex-direction: column;
    width: 100%;
  }
  .query-form__header {
    display: flex;
    .nav-action {
      flex: 1 1 0;
      overflow: hidden;
      display: flex;
    }
    .result-menu {
      display: flex;
    }
  }
`;function Je(e){var t,a;const{queryItem:n,onNavBack:i,total:u,isInPopper:d=!1,defaultPageSize:p=o.CONSTANTS.DEFAULT_QUERY_PAGE_SIZE,wrappedInPopper:f=!1,className:g="",index:v}=e,y=We(e,["queryItem","onNavBack","total","isInPopper","defaultPageSize","wrappedInPopper","className","index"]),S=o.hooks.useTranslation(h),[x,b]=o.React.useState(0),[R,w]=o.React.useState(!0),[I,C]=o.React.useState(0),j=o.React.useRef(null),N=o.React.useRef(null),[M,D]=o.React.useState(null),[O,P]=o.React.useState(null),[E,k]=o.React.useState(!0),T=o.React.useRef(n.sqlExprObj),L=o.React.useRef(null),B=o.React.useRef(),[A,z]=o.React.useState(null),V=Object.assign({},U,n),{icon:$,name:G,displayLabel:W}=V,H=_({widgetId:e.widgetId,useDataSourceId:null===(t=V.useDataSource)||void 0===t?void 0:t.dataSourceId});o.hooks.useEffectOnce((()=>{B.current.focus()}));const J=o.React.useMemo((()=>(0,o.Immutable)({dataSourceId:n.outputDataSourceId,mainDataSourceId:n.outputDataSourceId})),[n.outputDataSourceId]),K=o.React.useCallback((e=>{var t,a;const n=null!=e?e:O;if(null===(t=null==n?void 0:n.getDataSourceJson())||void 0===t?void 0:t.isOutputFromWidget){const e=n;null!=(null===(a=e.getCurrentQueryParams)||void 0===a?void 0:a.call(e)).geometry?k(!1):k(!0)}}),[O]),Q=o.React.useCallback((e=>{w(e),K()}),[K]),Y=o.React.useCallback(((e,t)=>{const a=n.outputDataSourceId,s=(null==e?void 0:e.widgetQueries)?e.widgetQueries[`setFilter-${a}`]:null,o=(null==t?void 0:t.widgetQueries)?t.widgetQueries[`setFilter-${a}`]:null;(null==s?void 0:s.where)!==(null==o?void 0:o.where)&&z(s)}),[n.outputDataSourceId]),X=o.React.useCallback((e=>{P(e),K(e)}),[K]),ee=o.React.useCallback((e=>{D(e)}),[]),te=o.React.useCallback((()=>Ze(this,void 0,void 0,(function*(){if(!M)return;const t=new o.DataRecordSetChangeMessage(e.widgetId,o.RecordSetChangeType.Remove,[M.id]);o.MessageManager.getInstance().publishMessage(t),yield o.MessageManager.getInstance().publishMessage(new o.DataRecordsSelectionChangeMessage(e.widgetId,[]))}))),[e.widgetId,M]),ae=o.React.useCallback(((e=!1)=>{e&&(N.current=null,null==M||M.setStatus(o.DataSourceStatus.NotReady),C(0),te()),b(0)}),[M,te]),ne=o.React.useCallback((()=>{b(1)}),[]),se=o.React.useCallback(((t,a)=>Ze(this,void 0,void 0,(function*(){T.current=t,L.current=a;const n=M;b(2),yield te(),function(e,t,a,n,r,i){var u,d,p;return je(this,void 0,void 0,(function*(){const f=e.getDataSourceJson(),g=e.getOriginDataSources()[0];(null==f?void 0:f.isDataInDataSourceInstance)&&e.setSourceRecords(g.getSourceRecords());const{useAttributeFilter:v,useSpatialFilter:h,sortOptions:y,resultFieldsType:S,resultDisplayFields:x,resultTitleExpression:b}=n;let R=x;if(null==x){const t=e.getSchema();R=(null==t?void 0:t.fields)?Object.values(t.fields).map((e=>e.jimuName)):[]}const w=e.mergeQueryParams(null!==(u=g.getCurrentQueryParams())&&void 0!==u?u:{},{where:v&&(null==t?void 0:t.sql)?t.sql:"1=1",sqlExpression:v&&(null==t?void 0:t.sql)?t:null}),I=Object.assign({returnGeometry:!0,page:r,pageSize:i},w);if(h&&(null==a?void 0:a.geometry)){const{geometry:e,relation:t=s.Intersect,buffer:n}=a,r={geometryType:o.dataSourceUtils.changeJSAPIGeometryTypeToRestAPIGeometryType(e.type),geometry:e.toJSON(),spatialRel:l[t],distance:null==n?void 0:n.distance,units:(null==n?void 0:n.unit)?c[n.unit]:void 0};Object.assign(I,r)}if((null==y?void 0:y.length)>0&&Object.assign(I,{orderByFields:y.map((e=>`${e.jimuFieldName} ${e.order}`))}),S===m.SelectAttributes){const t=function(e,t,a){const n=new Set;if(null==e||e.forEach((e=>n.add(e))),t){const e=t.match(/\{\w*\}/g);(null==e?void 0:e.length)>0&&e.forEach((e=>n.add(e.substring(1,e.length-1))))}return a&&n.add(a),Array.from(n)}(R,b,e.getIdField());Object.assign(I,{outFields:t})}else{const e=g.getPopupInfo(),t=Object.values(null!==(d=g.getSchema().fields)&&void 0!==d?d:{}).map((e=>e.name)),a=null===(p=null==e?void 0:e.fieldInfos)||void 0===p?void 0:p.filter((e=>t.includes(e.fieldName)));Object.assign(I,{outFields:null==a?void 0:a.map((e=>e.fieldName))})}return I}))}(n,t,a,V,1,p).then((t=>(j.current=t,n.setCountStatus(o.DataSourceStatus.Unloaded),function(e,t,a){return je(this,void 0,void 0,(function*(){return t.loadCount(a,{widgetId:e,refresh:!0})}))}(e.widgetId,n,t)))).then((t=>(C(t),n.updateQueryParams(j.current,e.widgetId),n.setStatus(o.DataSourceStatus.Unloaded),Me(e.widgetId,0,n,j.current)))).then((e=>{N.current=e.records})).finally((()=>{(null==a?void 0:a.layer)&&(null==a?void 0:a.clearAfterApply)&&a.layer.removeAll(),b(1)}))}))),[V,n,e.widgetId,M,p,te]),oe=o.React.useCallback((()=>{N.current=null,null==M||M.setStatus(o.DataSourceStatus.NotReady),C(0),te()}),[M,te]);return(0,o.jsx)("div",{className:(0,o.classNames)("query-task h-100 d-flex",g,{wrapped:f}),css:He},(0,o.jsx)("div",{className:(0,o.classNames)("query-task__content",{"d-none":0!==x,[r.FOCUSABLE_CONTAINER_CLASS]:1!==x&&d})},(0,o.jsx)(o.DataSourceComponent,{useDataSource:J,onDataSourceCreated:ee,onDataSourceInfoChange:Y}),(0,o.jsx)("div",{className:"query-form__header px-3 align-items-center"},(0,o.jsx)("div",{className:(0,o.classNames)("nav-action align-items-center",{"d-none":f})},(0,o.jsx)(r.Button,{className:(0,o.classNames)("p-0 mr-2",{"d-none":1===u}),size:"sm",type:"tertiary",icon:!0,onClick:i,"aria-label":S("back"),ref:B},(0,o.jsx)(Fe,{autoFlip:!0})),(0,o.jsx)(q,{icon:$,name:W?G:""})),(0,o.jsx)("div",{className:(0,o.classNames)("result-menu ml-auto align-items-center",{"d-none":0===I})},(0,o.jsx)(r.Tooltip,{title:S("checkResult"),placement:"bottom"},(0,o.jsx)(r.Button,{size:"sm",type:"tertiary","aria-label":S("checkResult"),icon:!0,onClick:ne},(0,o.jsx)(Ge,null))),(0,o.jsx)("div",{css:o.css`width: 1px; height: 16px; background-color: var(--light-400);`}),(0,o.jsx)(r.Tooltip,{title:S("clearResult"),placement:"bottom"},(0,o.jsx)(r.Button,{size:"sm",type:"tertiary","aria-label":S("clearResult"),icon:!0,onClick:oe},(0,o.jsx)(Z,null))))),R&&H&&(0,o.jsx)(fe,Object.assign({},y,{configId:n.configId,outputDS:M,datasourceReady:null!=O,spatialFilterEnabled:E,dataActionFilter:A,onFormSubmit:se})),(0,o.jsx)(F,{widgetId:e.widgetId,useDataSource:n.useDataSource,showMessage:!0,onStatusChange:Q,onDataSourceCreated:X})),(0,o.jsx)("div",{className:(0,o.classNames)("query-task__content",{"d-none":1!==x,[r.FOCUSABLE_CONTAINER_CLASS]:1===x&&d})},(0,o.jsx)(Ue,{widgetId:e.widgetId,queryItem:n,queryParams:j.current,resultCount:I,maxPerPage:null===(a=null==O?void 0:O.getMaxRecordCount)||void 0===a?void 0:a.call(O),records:N.current,defaultPageSize:p,outputDS:M,onNavBack:ae})),2===x&&(0,o.jsx)(r.Loading,{type:r.LoadingType.Donut}))}const Ke=()=>({name:k.TreeItemActionType.RenderOverrideItem,children:[{name:k.TreeItemActionType.RenderOverrideItemBody,children:[{name:k.TreeItemActionType.RenderOverrideItemMainLine}]}]});function Qe(e){var t;const{queryItems:a,widgetId:n,defaultPageSize:s,isInPopper:l=!1,className:i=""}=e,[c,u]=o.React.useState(0),[d,p]=o.React.useState((0,o.Immutable)({})),[f,m]=o.React.useState({index:0,id:null===(t=null==a?void 0:a[0])||void 0===t?void 0:t.configId}),g=o.React.useMemo((()=>{var e;const{index:t,id:n}=f;if(t>=0){if((null===(e=a[t])||void 0===e?void 0:e.configId)===n)return t;let s=-1;return a.find(((e,t)=>e.configId===n&&(s=t,!0))),-1===s&&(u(0),m({index:-1,id:null})),s}return t}),[a,f]),v=o.React.useCallback(((e,t)=>{const n=a[e].configId;p(d.set(n,!t))}),[a,d]),h=o.React.useCallback((()=>Array.from(a).map(((e,t)=>{var a;return{itemStateDetailContent:e,itemStateDisabled:null!==(a=d[e.configId])&&void 0!==a&&a,itemKey:`${t}`}}))),[a,d]);return(0,o.jsx)("div",{className:`runtime-query__query-list h-100 ${i}`,css:o.css`.jimu-tree-item__body {width: 100%;}`},0===c&&a.length>1&&(0,o.jsx)(k.List,{itemsJson:h(),overrideItemBlockInfo:Ke,onClickItemBody:(e,t)=>{const{itemJsons:a}=t.props,n=a[0];var s,o;s=+n.itemKey,o=n.itemStateDetailContent.configId,u(1),m({index:s,id:o})},renderOverrideItemMainLine:(e,t)=>{const{itemJsons:a}=t.props,s=a[0],r=s.itemStateDetailContent,l=+s.itemKey;return(0,o.jsx)(G,{key:r.configId,widgetId:n,index:l,queryItem:r,onStatusChange:e=>{v(l,e)}})},className:`px-3 ${l?r.FOCUSABLE_CONTAINER_CLASS:""}`}),(1===c||1===a.length)&&(0,o.jsx)(Je,{widgetId:n,index:a.length>1&&g>=0?g:0,total:a.length,queryItem:a[a.length>1&&g>=0?g:0],onNavBack:()=>{u(0),m({index:-1,id:null})},defaultPageSize:s,isInPopper:l}))}const Ye=[{name:"preventOverflow",options:{padding:1}}];function Xe(e){const{id:t,icon:a,label:n,forceClose:s,onOpenedChange:l,popperTitle:i,minSize:c,defaultSize:u,onWidthChange:d,buttonType:p="tertiary",children:f}=e,m=o.React.useRef(),g=o.React.useRef(0),[v,h]=o.React.useState(!1),[y,S]=o.React.useState(0),x=o.hooks.useCheckSmallBrowserSizeMode();o.React.useEffect((()=>{s&&h(!1)}),[s]),o.hooks.useEffectOnce((()=>{if("function"==typeof d){g.current=Math.round(m.current.clientWidth),d(t,g.current);const e=new ResizeObserver(o.lodash.throttle((e=>{const a=Math.round(e[0].contentRect.width);g.current!==a&&(g.current=a,d(t,a))}),200));return e.observe(m.current),()=>{e.disconnect()}}}));const b=o.React.useCallback((()=>{"function"==typeof l&&l(t,!v),h(!v),S(y+1),v&&setTimeout((()=>{(0,o.isKeyboardMode)()&&m.current.focus()}),200)}),[t,v,y,l]);return(0,o.jsx)("div",{className:"runtime-query__widget-popper"},(0,o.jsx)(r.Button,{title:n,"aria-label":n,icon:!0,size:"sm",type:p,ref:m,onClick:b},a&&(0,o.jsx)(r.Icon,Object.assign({size:16},"string"==typeof a?{icon:a,color:""}:{icon:a.svg,color:a.properties.color})),n&&(0,o.jsx)("div",{css:o.css`
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-break: break-word;
            word-wrap: break-word;
            line-height: 1.2;
          `,className:(0,o.classNames)({"ml-2":null!=a})},n)),x?(0,o.jsx)(r.MobilePanel,{open:v,title:i,onClose:b},f):(0,o.jsx)(r.Popper,{className:"ui-unit-popper ui-unit-popper_k-arrangement-icon flex-grow-1",floating:!0,forceLatestFocusElements:!0,headerClassName:r.FOCUSABLE_CONTAINER_CLASS,open:v,onHeaderClose:b,toggle:b,headerTitle:i,minSize:c,defaultSize:u,dragBounds:"body",version:y,reference:m.current,placement:"bottom-start",modifiers:Ye},f))}const{iconMap:et}=O(),tt=o.css`
  > div {
    margin-right: 8px;
  }
`;function at(e){const{queryItems:t,widgetId:a,minSize:n,defaultSize:s,defaultPageSize:r,widgetLabel:l,wrap:i=!1}=e,c=o.React.useRef(),u=o.React.useRef(0),d=o.React.useRef({}),[p,f]=o.React.useState(t.length),[m,g]=o.React.useState(-1),v=o.React.useRef(null),h=o.React.useCallback((()=>{let e=0;for(let a=0;a<p;a++){const n=t[a],s=d.current[n.configId];if(!(s>0))return;if(e+=s+8,e>=u.current&&p!==a)return void f(a)}f(t.length)}),[p,t]);o.React.useEffect((()=>(v.current&&v.current.disconnect(),v.current=new ResizeObserver(o.lodash.throttle((e=>{const t=Math.round(e[0].contentRect.width);u.current!==t&&(u.current=t,h())}),200)),v.current.observe(c.current),()=>{v.current.disconnect()})),[h]),o.hooks.useEffectOnce((()=>{var e;u.current=null===(e=c.current)||void 0===e?void 0:e.clientWidth,h()}));const y=o.React.useCallback(((e,a)=>{const n=t[e];d.current[n.configId]!==a&&(d.current[n.configId]=a,h())}),[t,h]),S=o.React.useCallback(((e,t)=>{t?g(e):e===m&&g(-1)}),[m]),[x,b]=o.React.useMemo((()=>{const e=[],a=[];for(let n=0;n<t.length;n++)n<p?e.push(t[n]):a.push(t[n]);return[e,a]}),[t,p]);return(0,o.jsx)("div",{ref:c,css:tt,className:(0,o.classNames)("runtime-query__query-list h-100 d-flex",{"flex-wrap":i,"align-content-start":i})},x.map(((e,t)=>{const l=Object.assign({},U,e);return(0,o.jsx)(Xe,{id:t,key:l.configId,icon:l.icon,buttonType:"default",label:l.displayLabel?l.name:void 0,popperTitle:l.name,onWidthChange:y,minSize:n,defaultSize:s,onOpenedChange:S,forceClose:m>=0&&m!==t},(0,o.jsx)(Je,{widgetId:a,index:t,total:1,isInPopper:!0,queryItem:l,wrappedInPopper:!0,className:"pb-3",defaultPageSize:r}))})),b.length>0&&(0,o.jsx)(Xe,{id:x.length+1,icon:et.iconMore,minSize:n,buttonType:"default",popperTitle:l,defaultSize:s,onOpenedChange:S,forceClose:m>=0&&m!==x.length+1},(0,o.jsx)(Qe,{widgetId:a,isInPopper:!0,defaultPageSize:r,queryItems:b,className:"py-3"})))}const{iconMap:nt}=O(),st=o.css`
  background-color: var(--white);
`;class ot extends o.React.PureComponent{render(){var e,t,n,s,l,i,c,u,d;const{config:p,id:f,icon:m,label:g,layoutId:v,layoutItemId:y}=this.props,S=this.props.intl.formatMessage({id:"_widgetLabel",defaultMessage:h._widgetLabel});return(null===(e=p.queryItems)||void 0===e?void 0:e.length)?p.arrangeType===a.Popper?(0,o.jsx)(ue.Provider,{value:`${v}:${y}`},(0,o.jsx)(Xe,{id:0,icon:m,popperTitle:g,minSize:null===(n=null===(t=p.sizeMap)||void 0===t?void 0:t.arrangementIconPopper)||void 0===n?void 0:n.minSize,defaultSize:null===(l=null===(s=p.sizeMap)||void 0===s?void 0:s.arrangementIconPopper)||void 0===l?void 0:l.defaultSize},(0,o.jsx)(Qe,{widgetId:f,isInPopper:!0,queryItems:p.queryItems,defaultPageSize:p.defaultPageSize,className:"py-3"}))):p.arrangeType===a.Inline?(0,o.jsx)(ue.Provider,{value:`${v}:${y}`},(0,o.jsx)(at,{widgetId:f,widgetLabel:g,wrap:p.arrangeWrap,queryItems:p.queryItems,minSize:null===(c=null===(i=p.sizeMap)||void 0===i?void 0:i.arrangementIconPopper)||void 0===c?void 0:c.minSize,defaultSize:null===(d=null===(u=p.sizeMap)||void 0===u?void 0:u.arrangementIconPopper)||void 0===d?void 0:d.defaultSize,defaultPageSize:p.defaultPageSize})):(0,o.jsx)("div",{className:"jimu-widget runtime-query py-3 surface-1 border-0",css:st},(0,o.jsx)(ue.Provider,{value:`${v}:${y}`},(0,o.jsx)(Qe,{widgetId:f,queryItems:p.queryItems,defaultPageSize:p.defaultPageSize}))):(0,o.jsx)(r.WidgetPlaceholder,{icon:nt.iconQuery,widgetId:this.props.id,message:S})}}ot.versionManager=E;const rt=ot;function lt(e){u.p=e}})(),d})())}}}));